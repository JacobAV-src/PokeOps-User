name: Mint Pokémon Card

on:
  issues:
    types: [closed]

permissions:
  contents: write

jobs:
  check_if_completed_issue:
    runs-on: ubuntu-latest
    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
    if: contains(github.event.issue.title, '[TASK COMPLETED]')
    steps:
      - uses: actions/checkout@v4

      - name: Comment: Starting mint
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "⏳ Starting Pokémon card minting..."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if issue already used
        run: |
          COMMENTS=$(gh issue view "$ISSUE_NUMBER" --json comments --jq '.comments[].body')
          if echo "$COMMENTS" | grep -q "✅ This issue has already been used for minting."; then
            echo "Issue already used."
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Mint the Card
        run: |
          echo "🎉 Task completed! Minting Pokémon card..."

          http_response=$(mktemp)
          body_response=$(mktemp)

          status=$(curl -s -o "$body_response" -w "%{http_code}" -X POST https://pokeops.onrender.com/mint-card \
            -H "Content-Type: application/json" \
            -d '{
              "username": "${{ github.actor }}",
              "repo": "${{ github.repository }}"
            }')

          if [ "$status" -ne 200 ]; then
            echo "Minting failed. HTTP $status"
            cat "$body_response"
            gh issue comment "$ISSUE_NUMBER" --body "❌ Minting failed. Backend returned HTTP $status."
            exit 1
          fi

          card_url=$(jq -r '.card.image' "$body_response")
          echo "CARD_URL=$card_url" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Binder HTML
        run: |
          HTML_ENTRY="<img src='${{ env.CARD_URL }}' alt='Pokemon Card' width='250' style='margin:10px;'>"

          # Ensure binder exists
          mkdir -p docs
          if [ ! -f docs/index.html ]; then
            echo "<html><body><h1>My Pokémon Card Binder</h1><div id='cards'></div></body></html>" > docs/index.html
          fi

          # Insert the card before the </body> tag
          sed -i "/<\/body>/i $HTML_ENTRY" docs/index.html

      - name: Commit and Push Binder
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add docs/index.html
          git commit -m "Add new card to binder"
          git push

          gh issue comment "$ISSUE_NUMBER" --body "✅ This issue has already been used for minting."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
