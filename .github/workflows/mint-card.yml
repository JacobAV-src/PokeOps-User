name: Mint Pok√©mon Card

on:
  issues:
    types: [closed]

permissions:
  contents: write

jobs:
  check_if_completed_issue:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, '[TASK COMPLETED]')
    steps:
      - uses: actions/checkout@v4

      - name: Mint the Card
        run: |
          echo "üéâ Task completed! Minting Pok√©mon card..."
          response=$(curl -X POST https://pokeops.onrender.com/mint-card \
            -H "Content-Type: application/json" \
            -d '{
              "username": "${{ github.actor }}",
              "repo": "${{ github.repository }}"
            }')

          echo "Backend response: $response"
          card_url=$(echo "$response" | jq -r '.card.image')

          echo "CARD_URL=$card_url" >> $GITHUB_ENV

      - name: Update Binder HTML
        run: |
          HTML_ENTRY="<img src='${{ env.CARD_URL }}' alt='Pokemon Card' width='250' style='margin:10px;'>"

          # Ensure binder exists
          mkdir -p docs
          if [ ! -f docs/index.html ]; then
            echo "<html><body><h1>My Pok√©mon Card Binder</h1><div id='cards'></div></body></html>" > docs/index.html
          fi

          # Insert the card before the </body> tag
          sed -i "/<\/body>/i $HTML_ENTRY" docs/index.html

      - name: Commit and Push Binder
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add docs/index.html
          git commit -m "Add new card to binder"
          git push

